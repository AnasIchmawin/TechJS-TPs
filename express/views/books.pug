doctype html
html(lang='en')
  head
    meta(charset='UTF-8')
    meta(name='viewport', content='width=device-width, initial-scale=1.0')
    title Books Library & Reading Tracker
    script(src='https://cdn.tailwindcss.com')
  body.bg-gradient-to-br.from-teal-50.to-cyan-100.min-h-screen
    nav.bg-slate-800.shadow-lg
      div(class='max-w-7xl mx-auto px-4 sm:px-6 lg:px-8')
        .flex.justify-between.items-center.h-16
          .flex.items-center.space-x-6
            h1.text-2xl.font-bold.text-orange-400 Book Library & Reading Tracker
          .flex.items-center.space-x-4
            span.text-slate-200 Welcome, 
              strong.text-orange-300= user.username
            form(action='/logout', method='POST')
              button.bg-rose-500.text-white.font-semibold.py-2.px-4.rounded.transition.duration-200(type='submit', class='hover:bg-rose-600') Logout
    
    main(class='max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8')
      //- Add Book Section
      .mb-8
        .flex.justify-between.items-center.mb-4
          div
            h2.text-3xl.font-bold.text-slate-800.mb-2 Add New Book
            p.text-slate-600 Expand your reading collection
          button#addBookBtn.bg-teal-600.text-white.font-semibold.py-2.px-6.rounded-lg.transition.duration-200(class='hover:bg-teal-700') + Add New Book
      
      //- Add Book Form (Hidden by default)
      #addBookForm.hidden.mb-8
        div(class='bg-white rounded-lg shadow-lg p-6')
          h3.text-2xl.font-bold.text-slate-800.mb-4 Book Details
          form#bookForm
            .grid.grid-cols-1.gap-4(class='md:grid-cols-2')
              div
                label.block.text-slate-700.font-semibold.mb-2(for='title') Title *
                input#title.w-full.px-4.py-2.border.rounded-lg(class='focus:outline-none focus:ring-2 focus:ring-teal-500', type='text', name='title', required)
              div
                label.block.text-slate-700.font-semibold.mb-2(for='author') Author *
                input#author.w-full.px-4.py-2.border.rounded-lg(class='focus:outline-none focus:ring-2 focus:ring-teal-500', type='text', name='author', required)
              div
                label.block.text-slate-700.font-semibold.mb-2(for='numberOfPages') Number of Pages *
                input#numberOfPages.w-full.px-4.py-2.border.rounded-lg(class='focus:outline-none focus:ring-2 focus:ring-teal-500', type='number', name='numberOfPages', min='0', required)
              div
                label.block.text-slate-700.font-semibold.mb-2(for='format') Format *
                select#format.w-full.px-4.py-2.border.rounded-lg(class='focus:outline-none focus:ring-2 focus:ring-teal-500', name='format', required)
                  option(value='Print') Print
                  option(value='PDF') PDF
                  option(value='EBook') EBook
                  option(value='AudioBook') AudioBook
              div
                label.block.text-slate-700.font-semibold.mb-2(for='status') Status *
                select#status.w-full.px-4.py-2.border.rounded-lg(class='focus:outline-none focus:ring-2 focus:ring-teal-500', name='status', required)
                  option(value='Unread') Unread
                  option(value='Want to read') Want to read
                  option(value='Currently reading') Currently reading
                  option(value='Read') Read
                  option(value='Re-read') Re-read
                  option(value='DNF') DNF
                  option(value='Returned') Returned
              div
                label.block.text-slate-700.font-semibold.mb-2(for='price') Price ($) *
                input#price.w-full.px-4.py-2.border.rounded-lg(class='focus:outline-none focus:ring-2 focus:ring-teal-500', type='number', name='price', min='0', step='0.01', required)
              div
                label.block.text-slate-700.font-semibold.mb-2(for='suggestedBy') Suggested By
                input#suggestedBy.w-full.px-4.py-2.border.rounded-lg(class='focus:outline-none focus:ring-2 focus:ring-teal-500', type='text', name='suggestedBy', placeholder='Who suggested this book?')
            .flex.gap-4.mt-4
              button.bg-teal-600.text-white.font-semibold.py-2.px-6.rounded-lg.transition.duration-200(type='submit', class='hover:bg-teal-700') Save Book
              button#cancelBtn.bg-slate-400.text-white.font-semibold.py-2.px-6.rounded-lg.transition.duration-200(type='button', class='hover:bg-slate-500') Cancel
          #message.mt-4.hidden

      //- All Books Section
      .mb-8
        h2.text-3xl.font-bold.text-slate-800.mb-6 All Books
        
        if books.length === 0
          .bg-white.rounded-lg.shadow.p-8.text-center
            p.text-slate-500.text-lg No books available. Add some books to start tracking!
        else
          .space-y-4
            each book in books
              .bg-white.rounded-lg.shadow-lg.p-6
                div(class='grid grid-cols-1 md:grid-cols-3 gap-6')
                  //- Book Info
                  .col-span-1
                    h3.text-xl.font-bold.text-slate-800.mb-2= book.title
                    p.text-slate-600.mb-1
                      span.font-semibold Author: 
                      span= book.author
                    if book.price
                      p.text-slate-600.mb-1
                        span.font-semibold Price: 
                        span $#{book.price}
                    if book.suggestedBy
                      p.text-slate-600.mb-1
                        span.font-semibold Suggested by: 
                        span= book.suggestedBy
                    div.flex.gap-2.mt-2
                      span.inline-block.bg-teal-100.text-teal-800.px-2.py-1.rounded.text-xs.font-semibold= book.format
                      span.inline-block.bg-orange-100.text-orange-800.px-2.py-1.rounded.text-xs.font-semibold= book.status
                  
                  //- Reading Progress
                  div(class='col-span-1 md:col-span-2')
                    .mb-4
                      .flex.justify-between.items-center.mb-2
                        span.font-semibold.text-slate-700 Reading Progress
                        span.text-lg.font-bold.text-teal-600= book.readingPercentage + '%'
                      .w-full.bg-slate-200.rounded-full.h-4
                        div.bg-gradient-to-r.from-teal-500.to-cyan-500.h-4.rounded-full.transition-all.duration-500(style=`width: ${book.readingPercentage}%`)
                      p.text-sm.text-slate-500.mt-1= `${book.numberOfPagesRead} / ${book.numberOfPages} pages`
                    
                    //- Update Progress Form
                    .flex.gap-2.items-end
                      div.flex-1
                        label.block.text-sm.font-semibold.text-slate-700.mb-1(for=`pages-${book._id}`) Pages Read
                        input.w-full.px-3.py-2.border.rounded-lg(class='focus:outline-none focus:ring-2 focus:ring-teal-500', id=`pages-${book._id}`, type='number', min='0', max=book.numberOfPages, value=book.numberOfPagesRead, data-book-id=book._id)
                      button.bg-teal-600.text-white.px-6.py-2.rounded-lg.font-semibold.transition(class='hover:bg-teal-700', onclick=`updateProgress('${book._id}')`) Update Progress
                      button.bg-rose-500.text-white.px-6.py-2.rounded-lg.font-semibold.transition(class='hover:bg-rose-600', onclick=`deleteBook('${book._id}')`) Delete
    
    script.
      // Toggle add book form
      document.getElementById('addBookBtn').addEventListener('click', function() {
        document.getElementById('addBookForm').classList.toggle('hidden');
      });
      
      // Cancel button
      document.getElementById('cancelBtn').addEventListener('click', function() {
        document.getElementById('addBookForm').classList.add('hidden');
        document.getElementById('bookForm').reset();
        document.getElementById('message').classList.add('hidden');
      });
      
      // Handle form submission
      document.getElementById('bookForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const formData = {
          title: document.getElementById('title').value,
          author: document.getElementById('author').value,
          numberOfPages: parseInt(document.getElementById('numberOfPages').value) || 0,
          format: document.getElementById('format').value,
          status: document.getElementById('status').value,
          price: parseFloat(document.getElementById('price').value) || 0,
          suggestedBy: document.getElementById('suggestedBy').value
        };
        
        try {
          const response = await fetch('/books/api/books', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(formData)
          });
          
          const result = await response.json();
          
          if (response.ok) {
            // Show success message
            const messageDiv = document.getElementById('message');
            messageDiv.className = 'mt-4 p-4 bg-green-100 text-green-700 rounded-lg';
            messageDiv.textContent = 'Book added successfully!';
            messageDiv.classList.remove('hidden');
            
            // Reset form
            document.getElementById('bookForm').reset();
            
            // Reload page after 1 second
            setTimeout(() => {
              window.location.reload();
            }, 1000);
          } else {
            throw new Error(result.message || 'Error adding book');
          }
        } catch (error) {
          const messageDiv = document.getElementById('message');
          messageDiv.className = 'mt-4 p-4 bg-red-100 text-red-700 rounded-lg';
          messageDiv.textContent = 'Error: ' + error.message;
          messageDiv.classList.remove('hidden');
        }
      });
      
      // Update progress function
      async function updateProgress(bookId) {
        const input = document.querySelector(`input[data-book-id="${bookId}"]`);
        const pagesRead = parseInt(input.value);
        
        if (isNaN(pagesRead) || pagesRead < 0) {
          alert('Please enter a valid number of pages');
          return;
        }
        
        try {
          const response = await fetch(`/books/api/books/${bookId}/progress`, {
            method: 'PUT',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ numberOfPagesRead: pagesRead })
          });
          
          const result = await response.json();
          
          if (response.ok) {
            // Reload page to show updated stats
            window.location.reload();
          } else {
            alert('Error: ' + result.message);
          }
        } catch (error) {
          alert('Error updating progress: ' + error.message);
        }
      }
      
      // Delete book function
      async function deleteBook(bookId) {
        if (!confirm('Are you sure you want to delete this book?')) {
          return;
        }
        
        try {
          const response = await fetch(`/books/api/books/${bookId}`, {
            method: 'DELETE'
          });
          
          const result = await response.json();
          
          if (response.ok) {
            window.location.reload();
          } else {
            alert('Error: ' + result.message);
          }
        } catch (error) {
          alert('Error deleting book: ' + error.message);
        }
      }
